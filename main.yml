---
- name: Initial server configuration and hardening
  import_playbook: plays/setup.yml

- name: Setup production REIMS2
  import_playbook: plays/reims.yml
  vars:
    frontend_domain: "{{ inventory_hostname }}"
    api_domain: "{{ 'api.' + inventory_hostname }}"
    db_name: "reims2-db"
    dokku_network_name: "reims2"
    frontend_app_name: "frontend"
    api_app_name: "api"
    docs_app_name: "docs"
    api_jwt_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      61313835653263643831623135346136323666323664393962633237386664313262383630323836
      3233363631653230663462333133313532646135333030610a376166633133636633613535336439
      64663064346161636331323239306334363536366337343763353035396437323462663863306438
      3537333265333831660a613036626437633862396136356263326264376530363831303932303133
      31336232383038363761303931653263393864393061393466636531396262346338363764316437
      37323734613362363531613464613434316566323937326636333962343031393365343833666136
      31356438353938636538616362363534613635633964343165373734343638643730376630336438
      61303936653961343861363134363162336165623862333334613130393739343461666238663033
      32646665633331613361613561323234353831346362353432616463616366306431336631636639
      32613163376466373063663738356435313964636461656434356264326565616330653339323361
      313035616432323538376138393431363434
    aws_key_id: AKIAYEM6NADWH3DNKDFE
    aws_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      65653939373763346338623764643464303830376537626462333835316563343237313066316564
      3332356661626161356461633938316530316539396563380a343764343763633463393232353936
      31363663656462356266306231616661373736396265393663313035613133376461333162363234
      3333663438383664340a376336383363376462343265323335343962386563303737326365376130
      34393135313537373965326338626638353661326133343836653435393964343736346530343135
      6665336566316538343635383639666164363030336437643633
    aws_bucket_name: reims2-backup
    db_dump: "{{ lookup('file', '../dump.sql', errors='warn') }}"

- name: Setup dev REIMS2
  import_playbook: plays/reims.yml
  vars:
    frontend_domain: "{{ 'dev.' + inventory_hostname }}"
    api_domain: "{{ 'dev-api.' + inventory_hostname }}"
    db_name: "dev-db"
    dokku_network_name: "dev-reims2"
    frontend_app_name: "dev-frontend"
    api_app_name: "dev-api"
    docs_app_name: "dev-docs"
    api_jwt_token: "testtokentesttokentesttokentesttokentesttokentesttokentesttokentesttokentesttokentesttokentesttokentesttokentesttoken"
    debug_enable: true
    db_dump: "{{ lookup('file', '../dump.sql', errors='warn') }}"

- name: Setup monitoring
  hosts: all
  become: true
  vars:
    monitoring_domain: "{{ 'monitoring.' + inventory_hostname }}"
    db_name: "reims2-db" # Creates a monitoring user for that dokku DB and exposes the DB on port 5000
    monitoring_db_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38346534326165633066363432363964653361623031363765663639343036616264653964346266
      6563616536366164376163616262303336653433366163350a316130613661376231303566393665
      37663365303839643930376430636661663035383261303461363862323034613031303632313732
      6563616565396262350a356562346661353431636138326236646233653965656464333436613233
      32666163343133373864643561346435366666666163343839343266613862303764
  tasks:
    - ansible.builtin.import_tasks: tasks/monitoring.yml
      tags: monitoring
